<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>解读 Erlang lists 源码 | 云在青天水在瓶</title>
  <meta name="baidu-site-verification" content="6b2f48c1baf35f9e0eb29b4455265203"/>
  <meta name="baidu-site-verification" content="hgXDOPtWLn" />
  <meta name="google-site-verification" content="YqjJD80rZQfugWoznvslaHlII_viwiMiUDEEgPTLEDw" />
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="/css/font-awesome/css/font-awesome.min.css" type="text/css" />
  <script src="/files/dc3da690b0d2a5655a8d6150862a2a07.html"></script>
  <!-- <link rel="stylesheet" href="/css/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="/css/default-min.css" type="text/css" />
  <link rel="stylesheet" href="/css/desktop-min.css" type="text/css" />
  <link rel="stylesheet" href="/css/mobile-min.css" type="text/css" />
  <link rel="shortcut icon" href="/css/favicon.ico" type="image/x-icon" />
  <link rel="icon" href="/css/favicon.ico" mce_href="/favicon.ico" type="image/x-icon">
  <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/atom.xml" />
  <script src="/js/jquery-1.11.0.min.js" type="text/javascript"></script>
  <script src="/js/jquery-migrate-1.2.1.min.js" type="text/javascript"></script>
  <script src="/js/jquery.transit.min.js" type="text/javascript"></script>
  <script src="/js/common.js" type="text/javascript"></script>
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>

  
  <!-- growingIO code -->
  <script type='text/javascript'>
      var _vds = _vds || [];
      window._vds = _vds;
      (function(){
        _vds.push(['setAccountId', '9f3f34627219ccd1']);
        (function() {
          var vds = document.createElement('script');
          vds.type='text/javascript';
          vds.async = true;
          vds.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'dn-growing.qbox.me/vds.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(vds, s);
        })();
      })();
  </script>
  
  <!-- 删掉 baidu spider 主动推送，无效 -->
  <!-- baidu spider initiative push -->
<!-- <script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
  </script> -->
  
  <!-- google analytics push code -->
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-72176628-2', 'auto');
      ga('send', 'pageview');
  </script>

</head>

<!-- meiqia plug-in -->
<!-- 
<script type='text/javascript'>
    (function(m, ei, q, i, a, j, s) {
        m[a] = m[a] || function() {
            (m[a].a = m[a].a || []).push(arguments)
        };
        j = ei.createElement(q),
            s = ei.getElementsByTagName(q)[0];
        j.async = true;
        j.charset = 'UTF-8';
        j.src = i + '?v=' + new Date().getUTCDate();
        s.parentNode.insertBefore(j, s);
    })(window, document, 'script', '//static.meiqia.com/dist/meiqia.js', '_MEIQIA');
    _MEIQIA('entId', 15857);
</script>
 -->

<body>
  <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
  html {
    /*background: #333333;*/
    background: rgb(246, 246, 246);
    -webkit-background-size: cover;
    -moz-background-size: cover;
    -o-background-size: cover;
    background-size: cover;
  }
  /*body { background:transparent;}*/
  @media screen and (max-width: 770px){
    body { background: rgba(255, 255, 255, 0.9); }
  }
</style>

<div id="content" class="post" style="margin-top: 20px;">
  <div id="avatar" class="avatar circle" data-in-right="false" style="width: 150px; height: 150px; position: fixed; top: 40px; z-index: 99; opacity: 0;">
    <div class="center" style="margin-top: 4px; height: 142px; width: 142px; border-radius: 71px; background-image: url('../images/2.jpg');"></div>
  </div>

  <div class="entry" style="position: relative;">
    <h1 class="entry-title"><a href="/erlang-lists-source-code" title="解读 Erlang lists 源码">解读 Erlang lists 源码</a></h1>    

    <p class="entry-date">2014-10-31 
        <span class="lastModified" style="display: none;" data-source="_posts/erlang/2014-10-31-erlang-lists-source-code.md">最后更新时间: 
        </span>
    </p>


    <h2 id="写在前面">写在前面</h2>
<p>　　lists官方文档在此<a href="http://erlang.org/doc/man/lists.html">http://erlang.org/doc/man/lists.html</a>，不知因为什么原因，官方文档中函数顺序和lists.erl源码里的顺序完全不一样。我是按照源码里的顺序来写的，目的是为了熟悉一下Erlang的编程风格和巩固基础语法。也不会所有函数都提到，挑下面一些来学习学习。</p>
<blockquote>

  <p><strong>1.  属性说明</strong>  <br />
<strong>2.  keyfind/3</strong><br />
<strong>3.  suffix/2</strong>   <br />
<strong>4.  seq/2, seq/3</strong><br />
<strong>5.  sort/1</strong>
<strong>6.  merge/1</strong><br />
<strong>7.  concat/1</strong><br />
<strong>8.  flatten/1, flatten/2</strong><br />
<strong>10. filter/2, map/2, filtermap/2</strong><br />
<strong>11. foldl/3, foldr/3</strong> <br />
<strong>12. keydelete/3</strong><br />
<strong>13. keymap/3</strong></p>
</blockquote>

<h2 id="1-属性说明">1. 属性说明</h2>

<p>　　源文件里注明了 <code class="highlighter-rouge">-compile({no_auto_import, [max/2]}).</code>，这是一个预定义的模块属性【预定义的模块属性有以下四种：<code class="highlighter-rouge">module，import，export，compile，vsn</code>】。其中<code class="highlighter-rouge">-compile(Options)</code>是将Options添加到编译器选项表中，Options可以是单个原子，也可以是一个列表。这里的<code class="highlighter-rouge">no_auto_import</code>是说函数max/2不要自动从erlang模块里导出了，这是为了解决内置函数冲突。没听明白吧，ok，下面详细讲讲这个。至于模块属性，详见《Erlang程序设计》第二版，8.4节；有关compile选项，请移步<a href="http://erlang.org/doc/man/compile.html">http://erlang.org/doc/man/compile.html</a>。<br />
　　首先，什么叫自动导出：easy，自动导出就是你不加模块前缀就可以运行的函数。平常使用模块函数不都是模块名:函数名的吗。比如说我们要使用erlang模块里的max函数，一般都是erlang:max这样使用。so，顾名思义，如果max函数在erlang里是自动导出的，那我猜想我们可以直接在console里运行max函数了，而且注意，在console里不加模块名直接运行的max函数一定是定义在erlang这个模块里面的。猜想一下，如果含有其他模块【假定为erl】也定义了一个max函数，并且也自动导出了，那当你直接运行max函数时，erlang虚拟机是该运行erl里的max呢还是erlang里的max呢。<br />
　　好的，简单测试下，直接看代码得了:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">root@kali:~/Desktop/erlcode# erl
Erlang/OTP 17 <span class="o">[</span>erts-6.1] <span class="o">[</span><span class="nb">source</span><span class="o">]</span> <span class="o">[</span>64-bit] <span class="o">[</span>smp:4:4] <span class="o">[</span>async-threads:10] <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

Eshell V6.1  <span class="o">(</span>abort with ^G<span class="o">)</span>
1&gt; erlang:max<span class="o">(</span>1,2<span class="o">)</span><span class="nb">.</span>
2
2&gt; max<span class="o">(</span>1,2<span class="o">)</span><span class="nb">.</span>
2
3&gt;</code></pre></figure>

<p>　　现在，这个问题解决了，那我们来看看，为什么在lists模块里要阻止max/2自动导入呢。just think it，就和我上面说的一样，防止自动导出的核心是什么？不就是为了防止函数冲突吗？so，我猜想我们lists.erl模块里也有一个max/2函数，而且这个max/2函数的实现必须是和erlang模块里的实现是不同的。CTRL+F查找，果然不出所料：　　</p>

<figure class="highlight"><pre><code class="language-erlang" data-lang="erlang"><span class="c">%% max(L) -&gt; returns the maximum element of the list L
</span>
<span class="p">-</span><span class="ni">spec</span> <span class="nf">max</span><span class="p">(</span><span class="nv">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Max</span> <span class="k">when</span>
      <span class="nv">List</span> <span class="p">::</span> <span class="p">[</span><span class="nv">T</span><span class="p">,...],</span>
      <span class="nv">Max</span> <span class="p">::</span> <span class="nv">T</span><span class="p">,</span>
      <span class="nv">T</span> <span class="p">::</span> <span class="nf">term</span><span class="p">().</span>

<span class="nf">max</span><span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nf">max</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span> <span class="nv">H</span><span class="p">).</span>

<span class="nf">max</span><span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">],</span> <span class="nv">Max</span><span class="p">)</span> <span class="k">when</span> <span class="nv">H</span> <span class="o">&gt;</span> <span class="nv">Max</span> <span class="o">-&gt;</span> <span class="nf">max</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span> <span class="nv">H</span><span class="p">);</span>
<span class="nf">max</span><span class="p">([_|</span><span class="nv">T</span><span class="p">],</span> <span class="nv">Max</span><span class="p">)</span>              <span class="o">-&gt;</span> <span class="nf">max</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span> <span class="nv">Max</span><span class="p">);</span>
<span class="nf">max</span><span class="p">([],</span>    <span class="nv">Max</span><span class="p">)</span>              <span class="o">-&gt;</span> <span class="nv">Max</span><span class="p">.</span></code></pre></figure>

<p>　　好了，到这里关于模块预定义属性就差不多了，以后遇到了再慢慢补上。</p>

<h2 id="2-keyfind3">2. keyfind/3</h2>
<p>　　lists里的<code class="highlighter-rouge">keyfind/3, keymember/3, keysearch/3, member/2, reverse/2</code>都是通过内置函数实现的，源码都在erl_bif_types.erl这个文件里面。在keyfind/3的定义中，看到了pos_integer()这样一个变量类型，看来基础还是不行啊，没办法，大家有空都来这里补补基础吧。<a href="http://www.erlang.org/doc/reference_manual/typespec.html">7 Types and Function Specifications</a></p>

<h2 id="3-suffix2">3. suffix/2</h2>
<p>　　之所以要介绍suffix，是想借suffix来简单介绍一下Erlang里的布尔表达式和所谓的短路布尔表达式。函数定义和实现如下，检查Suffix是否是List的后缀。实现就用了两行，真是精湛啊，突然发现其实很多操作不用循环也能很清楚的表达了。<br />
　　这里的 andalso 叫做短路布尔表达式，其含义是指 <code class="highlighter-rouge">Expr1 andalso Expr2</code> 这样一个表达式只有在Expr1为真的情况下才会执行Expr2。同样可以理解一下orelse这个短路布尔表达式。而普通的布尔表达式和其他语言里一样的，not, and, or, xor。</p>

<figure class="highlight"><pre><code class="language-erlang" data-lang="erlang"><span class="c">%% suffix(Suffix, List) -&gt; (true | false)
</span>
<span class="p">-</span><span class="ni">spec</span> <span class="nf">suffix</span><span class="p">(</span><span class="nv">List1</span><span class="p">,</span> <span class="nv">List2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nf">boolean</span><span class="p">()</span> <span class="k">when</span>
      <span class="nv">List1</span> <span class="p">::</span> <span class="p">[</span><span class="nv">T</span><span class="p">],</span>
      <span class="nv">List2</span> <span class="p">::</span> <span class="p">[</span><span class="nv">T</span><span class="p">],</span>
      <span class="nv">T</span> <span class="p">::</span> <span class="nf">term</span><span class="p">().</span>

<span class="nf">suffix</span><span class="p">(</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">List</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">Delta</span> <span class="o">=</span> <span class="nb">length</span><span class="p">(</span><span class="nv">List</span><span class="p">)</span> <span class="o">-</span> <span class="nb">length</span><span class="p">(</span><span class="nv">Suffix</span><span class="p">),</span>
    <span class="nv">Delta</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">andalso</span> <span class="nf">nthtail</span><span class="p">(</span><span class="nv">Delta</span><span class="p">,</span> <span class="nv">List</span><span class="p">)</span> <span class="o">=:=</span> <span class="nv">Suffix</span><span class="p">.</span></code></pre></figure>

<h2 id="4-seq2">4. seq/2</h2>
<p>　　seq/2是一个高级接口，调用了一个三参数的接口<code class="highlighter-rouge">seq_loop(N, X, L)</code>，如下，其中N=Last-First+1，是需要生成的长度，X=Last，是最后一个元素的值，L是一个空列表[]，将结果保存到第三个参数L中，最后再返回它。而生成这个列表的方法确实很高效，要么一次生成4个数，要么一次生成2个数，要么生成一个数或者直接返回结果。而实际应用中，大多数情况应该都是一次生成4个数，然后可能会调用1到2次一次生成2个数，最后要么直接返回结果，要么就再生成1个数后再返回结果。极为高效！我又想起了Python里相似的range函数，过两天看看Python里是怎么实现的。</p>

<figure class="highlight"><pre><code class="language-erlang" data-lang="erlang"><span class="p">-</span><span class="ni">spec</span> <span class="nf">seq</span><span class="p">(</span><span class="nv">From</span><span class="p">,</span> <span class="nv">To</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Seq</span> <span class="k">when</span>
      <span class="nv">From</span> <span class="p">::</span> <span class="nf">integer</span><span class="p">(),</span>
      <span class="nv">To</span> <span class="p">::</span> <span class="nf">integer</span><span class="p">(),</span>
      <span class="nv">Seq</span> <span class="p">::</span> <span class="p">[</span><span class="nf">integer</span><span class="p">()].</span>

<span class="nf">seq</span><span class="p">(</span><span class="nv">First</span><span class="p">,</span> <span class="nv">Last</span><span class="p">)</span>
    <span class="k">when</span> <span class="nb">is_integer</span><span class="p">(</span><span class="nv">First</span><span class="p">),</span> <span class="nb">is_integer</span><span class="p">(</span><span class="nv">Last</span><span class="p">),</span> <span class="nv">First</span><span class="o">-</span><span class="mi">1</span> <span class="o">=&lt;</span> <span class="nv">Last</span> <span class="o">-&gt;</span>
    <span class="nf">seq_loop</span><span class="p">(</span><span class="nv">Last</span><span class="o">-</span><span class="nv">First</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nv">Last</span><span class="p">,</span> <span class="p">[]).</span>

<span class="nf">seq_loop</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">X</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span> <span class="k">when</span> <span class="nv">N</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">-&gt;</span>
     <span class="nf">seq_loop</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="nv">X</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="p">[</span><span class="nv">X</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="nv">X</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="nv">X</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nv">X</span><span class="p">|</span><span class="nv">L</span><span class="p">]);</span>
<span class="nf">seq_loop</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">X</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span> <span class="k">when</span> <span class="nv">N</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">-&gt;</span>
     <span class="nf">seq_loop</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="nv">X</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="nv">X</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nv">X</span><span class="p">|</span><span class="nv">L</span><span class="p">]);</span>
<span class="nf">seq_loop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">X</span><span class="p">,</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
     <span class="p">[</span><span class="nv">X</span><span class="p">|</span><span class="nv">L</span><span class="p">];</span>
<span class="nf">seq_loop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">_,</span> <span class="nv">L</span><span class="p">)</span> <span class="o">-&gt;</span>
     <span class="nv">L</span><span class="p">.</span></code></pre></figure>

<h2 id="5-sort1">5. sort/1</h2>
<p>　　Link:</p>

<h2 id="6-merge1">6. merge/1</h2>
<p>　　Link:</p>

<h2 id="7-concat1">7. concat/1</h2>
<p>　　concat函数本身的意图是把参数组合成一个项式，特别需要注意的是，当这个项式是可打印的时候，就打印其字符串形式的结果，当该项式是不可打印的时候，就以把它组合成一个list形式。我们先看下面的例子：</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">  

root@kali:~/Desktop/erlcode/lists# erl
Erlang/OTP 17 <span class="o">[</span>erts-6.1] <span class="o">[</span><span class="nb">source</span><span class="o">]</span> <span class="o">[</span>64-bit] <span class="o">[</span>smp:4:4] <span class="o">[</span>async-threads:10] <span class="o">[</span>hipe] <span class="o">[</span>kernel-poll:false]

Eshell V6.1  <span class="o">(</span>abort with ^G<span class="o">)</span>
1&gt; lists:concat<span class="o">([</span>1,2,3]<span class="o">)</span><span class="nb">.</span>
<span class="s2">"123"</span>
2&gt; lists:concat<span class="o">([</span>1,2,3,a,b,c]<span class="o">)</span><span class="nb">.</span>
<span class="s2">"123abc"</span>
3&gt; lists:concat<span class="o">([</span>1,2,3,[a,b,c]]<span class="o">)</span><span class="nb">.</span>
<span class="o">[</span>49,50,51,a,b,c]
4&gt; lists:concat<span class="o">([</span>1,2,3,[1,2,3]]<span class="o">)</span><span class="nb">.</span>
<span class="o">[</span>49,50,51,1,2,3]
5&gt; lists:concat<span class="o">([</span>1,2,3,a,b,c,[1,2,3]]<span class="o">)</span><span class="nb">.</span>
<span class="o">[</span>49,50,51,97,98,99,1,2,3]
6&gt; lists:concat<span class="o">([</span>1,2,3,a,b,c,[1,2,[a,b,c],3]]<span class="o">)</span><span class="nb">.</span>
<span class="o">[</span>49,50,51,97,98,99,1,2,[a,b,c],3]
7&gt; lists:concat<span class="o">([</span>1,2,3,a,b,c,[1,2,[a,b,c],3],d,e,f]<span class="o">)</span><span class="nb">.</span>
<span class="o">[</span>49,50,51,97,98,99,1,2,[a,b,c],3,100,101,102]</code></pre></figure>

<p>　　从例子1、2可以看出，若参数是一个无嵌套的term组成的list，则会返回由这些term组成的一个字符串；若参数是含有嵌套的list，则会把最外层term打印成其在ASCII中的下标，而嵌套的会保持原形。我想这个函数一般都会用在无嵌套的情况吧。下面是源码。</p>

<figure class="highlight"><pre><code class="language-erlang" data-lang="erlang"><span class="c">%% concat(L) concatenate the list representation of the elements
%%  in L - the elements in L can be atoms, numbers of strings.
%%  Returns a list of characters.
</span>
<span class="p">-</span><span class="ni">spec</span> <span class="nf">concat</span><span class="p">(</span><span class="nv">Things</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nf">string</span><span class="p">()</span> <span class="k">when</span>
      <span class="nv">Things</span> <span class="p">::</span> <span class="p">[</span><span class="nv">Thing</span><span class="p">],</span>
      <span class="nv">Thing</span> <span class="p">::</span> <span class="nf">atom</span><span class="p">()</span> <span class="p">|</span> <span class="nf">integer</span><span class="p">()</span> <span class="p">|</span> <span class="nb">float</span><span class="p">()</span> <span class="p">|</span> <span class="nf">string</span><span class="p">().</span>

<span class="nf">concat</span><span class="p">(</span><span class="nv">List</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">flatmap</span><span class="p">(</span><span class="k">fun</span> <span class="n">thing_to_list</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="nv">List</span><span class="p">).</span>

<span class="nf">thing_to_list</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_integer</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">integer_to_list</span><span class="p">(</span><span class="nv">X</span><span class="p">);</span>
<span class="nf">thing_to_list</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_float</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span>   <span class="o">-&gt;</span> <span class="nb">float_to_list</span><span class="p">(</span><span class="nv">X</span><span class="p">);</span>
<span class="nf">thing_to_list</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_atom</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span>    <span class="o">-&gt;</span> <span class="nb">atom_to_list</span><span class="p">(</span><span class="nv">X</span><span class="p">);</span>
<span class="nf">thing_to_list</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_list</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span>    <span class="o">-&gt;</span> <span class="nv">X</span><span class="p">.</span>       <span class="c">%Assumed to be a string
</span>
<span class="p">-</span><span class="ni">spec</span> <span class="nf">flatmap</span><span class="p">(</span><span class="nv">Fun</span><span class="p">,</span> <span class="nv">List1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">List2</span> <span class="k">when</span>
      <span class="nv">Fun</span> <span class="p">::</span> <span class="k">fun</span><span class="p">((</span><span class="nv">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">B</span><span class="p">]),</span>
      <span class="nv">List1</span> <span class="p">::</span> <span class="p">[</span><span class="nv">A</span><span class="p">],</span>
      <span class="nv">List2</span> <span class="p">::</span> <span class="p">[</span><span class="nv">B</span><span class="p">],</span>
      <span class="nv">A</span> <span class="p">::</span> <span class="nf">term</span><span class="p">(),</span>
      <span class="nv">B</span> <span class="p">::</span> <span class="nf">term</span><span class="p">().</span>

<span class="nf">flatmap</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="p">[</span><span class="nv">Hd</span><span class="p">|</span><span class="nv">Tail</span><span class="p">])</span> <span class="o">-&gt;</span>
    <span class="nv">F</span><span class="p">(</span><span class="nv">Hd</span><span class="p">)</span> <span class="o">++</span> <span class="nf">flatmap</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">);</span>
<span class="nf">flatmap</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="p">[])</span> <span class="k">when</span> <span class="nb">is_function</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[].</span></code></pre></figure>

<h2 id="8-flatten1-flatten2">8. flatten/1, flatten/2</h2>

<p>　　flatten/1 和 flatten/2 都是把一个有嵌套的list返回成一个无嵌套的list的函数，其中flatten/2允许在flatten/1的结果后再append一个list，而且不管这个list的形式。其实一会儿可以在源码里看见，flatten/1和flatten/2的唯一区别是flatten/1相当于flatten/2的第二个参数是一个空list。</p>

<figure class="highlight"><pre><code class="language-erlang" data-lang="erlang">  

<span class="p">-</span><span class="ni">spec</span> <span class="nf">flatten</span><span class="p">(</span><span class="nv">DeepList</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">List</span> <span class="k">when</span>
      <span class="nv">DeepList</span> <span class="p">::</span> <span class="p">[</span><span class="nf">term</span><span class="p">()</span> <span class="p">|</span> <span class="nv">DeepList</span><span class="p">],</span>
      <span class="nv">List</span> <span class="p">::</span> <span class="p">[</span><span class="nf">term</span><span class="p">()].</span>

<span class="nf">flatten</span><span class="p">(</span><span class="nv">List</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_list</span><span class="p">(</span><span class="nv">List</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">do_flatten</span><span class="p">(</span><span class="nv">List</span><span class="p">,</span> <span class="p">[]).</span>

<span class="p">-</span><span class="ni">spec</span> <span class="nf">flatten</span><span class="p">(</span><span class="nv">DeepList</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">List</span> <span class="k">when</span>
      <span class="nv">DeepList</span> <span class="p">::</span> <span class="p">[</span><span class="nf">term</span><span class="p">()</span> <span class="p">|</span> <span class="nv">DeepList</span><span class="p">],</span>
      <span class="nv">Tail</span> <span class="p">::</span> <span class="p">[</span><span class="nf">term</span><span class="p">()],</span>
      <span class="nv">List</span> <span class="p">::</span> <span class="p">[</span><span class="nf">term</span><span class="p">()].</span>

<span class="nf">flatten</span><span class="p">(</span><span class="nv">List</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_list</span><span class="p">(</span><span class="nv">List</span><span class="p">),</span> <span class="nb">is_list</span><span class="p">(</span><span class="nv">Tail</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">do_flatten</span><span class="p">(</span><span class="nv">List</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">).</span>

<span class="nf">do_flatten</span><span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">],</span> <span class="nv">Tail</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_list</span><span class="p">(</span><span class="nv">H</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nf">do_flatten</span><span class="p">(</span><span class="nv">H</span><span class="p">,</span> <span class="nf">do_flatten</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">));</span>
<span class="nf">do_flatten</span><span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">],</span> <span class="nv">Tail</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nv">H</span><span class="p">|</span><span class="nf">do_flatten</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">)];</span>
<span class="nf">do_flatten</span><span class="p">([],</span> <span class="nv">Tail</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">Tail</span><span class="p">.</span></code></pre></figure>

<h2 id="10-filter2-map2-filtermap2">10. filter/2, map/2, filtermap/2</h2>

<p>　　先看看函数参数，filter函数是对List1里的每个term都应用一次Pred函数，然后将能使Pred函数返回true的元素按序构成一个新的列表返回。map函数是对List1里对每个term都应用一次Fun函数，然后将Fun函数在每个元素上都返回值按顺序构造成返回值。顾名思义，filtermap函数就是这两个函数的结合，即先filter，再做map操作。下面是源码，有时候发现，如果看document看烦了，可以选择性地看看源码，也许比看document管用。</p>

<figure class="highlight"><pre><code class="language-erlang" data-lang="erlang"><span class="p">-</span><span class="ni">spec</span> <span class="nf">map</span><span class="p">(</span><span class="nv">Fun</span><span class="p">,</span> <span class="nv">List1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">List2</span> <span class="k">when</span>
      <span class="nv">Fun</span> <span class="p">::</span> <span class="k">fun</span><span class="p">((</span><span class="nv">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">B</span><span class="p">),</span>
      <span class="nv">List1</span> <span class="p">::</span> <span class="p">[</span><span class="nv">A</span><span class="p">],</span>
      <span class="nv">List2</span> <span class="p">::</span> <span class="p">[</span><span class="nv">B</span><span class="p">],</span>
      <span class="nv">A</span> <span class="p">::</span> <span class="nf">term</span><span class="p">(),</span>
      <span class="nv">B</span> <span class="p">::</span> <span class="nf">term</span><span class="p">().</span>

<span class="nf">map</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="p">[</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">])</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nv">F</span><span class="p">(</span><span class="nv">H</span><span class="p">)|</span><span class="nf">map</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="nv">T</span><span class="p">)];</span>
<span class="nf">map</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="p">[])</span> <span class="k">when</span> <span class="nb">is_function</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[].</span>

<span class="p">-</span><span class="ni">spec</span> <span class="nf">filter</span><span class="p">(</span><span class="nv">Pred</span><span class="p">,</span> <span class="nv">List1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">List2</span> <span class="k">when</span>
      <span class="nv">Pred</span> <span class="p">::</span> <span class="k">fun</span><span class="p">((</span><span class="nv">Elem</span> <span class="p">::</span> <span class="nv">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nf">boolean</span><span class="p">()),</span>
      <span class="nv">List1</span> <span class="p">::</span> <span class="p">[</span><span class="nv">T</span><span class="p">],</span>
      <span class="nv">List2</span> <span class="p">::</span> <span class="p">[</span><span class="nv">T</span><span class="p">],</span>
      <span class="nv">T</span> <span class="p">::</span> <span class="nf">term</span><span class="p">().</span>

<span class="nf">filter</span><span class="p">(</span><span class="nv">Pred</span><span class="p">,</span> <span class="nv">List</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_function</span><span class="p">(</span><span class="nv">Pred</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[</span> <span class="nv">E</span> <span class="p">||</span> <span class="nv">E</span> <span class="o">&lt;-</span> <span class="nv">List</span><span class="p">,</span> <span class="nv">Pred</span><span class="p">(</span><span class="nv">E</span><span class="p">)</span> <span class="p">].</span>   

<span class="p">-</span><span class="ni">spec</span> <span class="nf">filtermap</span><span class="p">(</span><span class="nv">Fun</span><span class="p">,</span> <span class="nv">List1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">List2</span> <span class="k">when</span>
      <span class="nv">Fun</span> <span class="p">::</span> <span class="k">fun</span><span class="p">((</span><span class="nv">Elem</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nf">boolean</span><span class="p">()</span> <span class="p">|</span> <span class="p">{</span><span class="n">'true'</span><span class="p">,</span> <span class="nv">Value</span><span class="p">}),</span>
      <span class="nv">List1</span> <span class="p">::</span> <span class="p">[</span><span class="nv">Elem</span><span class="p">],</span>
      <span class="nv">List2</span> <span class="p">::</span> <span class="p">[</span><span class="nv">Elem</span> <span class="p">|</span> <span class="nv">Value</span><span class="p">],</span>
      <span class="nv">Elem</span> <span class="p">::</span> <span class="nf">term</span><span class="p">(),</span>
      <span class="nv">Value</span> <span class="p">::</span> <span class="nf">term</span><span class="p">().</span>

<span class="nf">filtermap</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="p">[</span><span class="nv">Hd</span><span class="p">|</span><span class="nv">Tail</span><span class="p">])</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="nv">F</span><span class="p">(</span><span class="nv">Hd</span><span class="p">)</span> <span class="k">of</span>
  <span class="n">true</span> <span class="o">-&gt;</span>
      <span class="p">[</span><span class="nv">Hd</span><span class="p">|</span><span class="nf">filtermap</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">)];</span>
  <span class="p">{</span><span class="n">true</span><span class="p">,</span><span class="nv">Val</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="p">[</span><span class="nv">Val</span><span class="p">|</span><span class="nf">filtermap</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">)];</span>
  <span class="n">false</span> <span class="o">-&gt;</span>
      <span class="nf">filtermap</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="nv">Tail</span><span class="p">)</span>
    <span class="k">end</span><span class="p">;</span>
<span class="nf">filtermap</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="p">[])</span> <span class="k">when</span> <span class="nb">is_function</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[].</span></code></pre></figure>

<h2 id="扫一扫">扫一扫</h2>

<p><img src="../../images/share/2014-10-31-erlang-lists-source-code.md.jpg" alt="2014-10-31-erlang-lists-source-code.md" /></p>


    <!-- share icon -->
    <!-- <div class="ds-share" data-thread-key="/erlang-lists-source-code" data-title="解读 Erlang lists 源码"
         data-content="content"
         data-url="http://litaotao.github.io//erlang-lists-source-code">
        <div class="ds-share-aside-left">
          <div class="ds-share-aside-inner">
          </div>
          <div class="ds-share-aside-toggle">分享</div>
        </div>
    </div>
 -->
    <!-- 百度分享按钮 -->

<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"7","bdPos":"left","bdTop":"118"},"image":{"viewList":["weixin","qzone","tsina","tqq","renren","sqq","evernotecn","youdao"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["weixin","qzone","tsina","tqq","renren","sqq","evernotecn","youdao"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>


<!--     <div id="disqus_container">
      <div style="margin-bottom:20px">
      多说评论框 start
        <div class="ds-thread" data-thread-key=/erlang-lists-source-code data-title=解读 Erlang lists 源码 
             data-url=http://localhost:4000+/erlang-lists-source-code></div>
      多说评论框 end
      多说公共JS代码 start (一个网页只需插入一次)
      <script type="text/javascript">
      var duoshuoQuery = {short_name:"litaotao"};
        (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          // ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.src = '../js/embed.js'
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
           || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
        </script>
      多说公共JS代码 end
      </div>
    </div> -->

        <div id="disqus_thread"></div>
            <script>

            /**
            *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
            *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
            /*
            var disqus_config = function () {
            this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
            this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
            };
            */
            (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = 'https://litaotao-github-io.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
            })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>    

  </div>
  
  <div id="menuIndex" class="sidenav">
    <div class="myinfo">
        <center>
          <div id="avatarHolder" class="avatar circle" style="width: 0px; height: 0px; box-shadow: none; margin-bottom: 20px;">
          </div>
          <a href="/index.html" title="Homepage"><i class="icon-home icon-large"></i> Home</a>
          <a href="http://www.linkedin.com/in/taotaoli"><i class="icon-linkedin-sign icon-large"></i> Linkedin</a>
          <a href="https://github.com/zxy"><i class="icon-github icon-large"></i> Code</a>
          <a href="mailto:1757943205@qq.com"><i class="icon-envelope icon-large"></i> Mail</a>
          <button id="present_button" onclick="present_mode()" style="width: 100%; margin-top: 10px; display: none"><i class="icon-align-justify icon-large"></i> Present Mode</button>
        </center>
    </div>
    <div id="menu"></div>
  </div>
</div>

<script src="/js/post.js" type="text/javascript"></script>
<script type="text/javascript">
    //博文页面也做一下刷新操作，避免有时候切换横竖屏时格式不对的问题  
    // $( window ).resize(function() { 
    //     location.reload(); 
    // });
</script>


  <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write(unescape("%3Cspan id='cnzz_stat_icon_1258855744'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1258855744' type='text/javascript'%3E%3C/script%3E"));
  </script>

</body>
</html>
